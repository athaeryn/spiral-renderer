<script>
"use strict";

var domLoaded = new Promise(resolve => {
  document.addEventListener('DOMContentLoaded', resolve)
})

var imgLoaded = new Promise(resolve => {
  var img = new Image()
  img.onload = () => resolve(img)
  img.src = '/test.png'
})

Promise.all([imgLoaded, domLoaded])
  .then(function go(args) {

var img = args[0]

var W = 1000
var H = W
var center = [W / 2, H / 2]

var canvas = document.createElement('canvas')
var ctx = canvas.getContext('2d')

ctx.fillStyle = 'black'
ctx.strokeStyle = 'black'

canvas.width = W
canvas.height = H

canvas.style.display = 'block'

;[ 'display:flex'
, 'justifyContent:center'
, 'alignItems:center'
, 'overflow:hidden'
].map(function (rule) { return rule.split(':') })
  .forEach(function (rule) {
    document.body.style[rule[0]] = rule[1]
  })



ctx.drawImage(img, 0, 0)


var imgData = ctx.getImageData(0, 0, W, H).data

clear()
// document.body.appendChild(img)
document.body.appendChild(canvas)

ctx.beginPath()
for (var t = 0; t < Math.PI * 400; t += 0.04) {
  var rad = t * .35
  var coord = add(center, [
    Math.sin(t) * rad,
    Math.cos(t) * rad
  ])
  ctx[shouldDrawAt(coord) ? 'lineTo' : 'moveTo'].apply(ctx, coord)
}
ctx.lineWidth = 1.2
ctx.stroke()



function shouldDrawAt (coord) {
  var x = ~~(coord[0])
  var y = ~~(coord[1])
  var index = (x + y * W) * 4
  return imgData[index] === 0
}



// adds two points ([x, y])
function add (a, b) {
  return [
    a[0] + b[0],
    a[1] + b[1]
  ]
}


function clear () {
  ctx.fillStyle = 'white'
  ctx.fillRect(0, 0, W, H)
  ctx.fillRect = 'black'
}


})
.catch(function (err) {
  console.log('error', err)
})



</script>

